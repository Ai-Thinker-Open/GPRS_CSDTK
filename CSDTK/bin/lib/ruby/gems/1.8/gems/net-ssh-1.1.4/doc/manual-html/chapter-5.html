<html>
  <head>
    <title>Net::SSH Manual :: Chapter 5: User Shells</title>
    <link type="text/css" rel="stylesheet" href="stylesheets/manual.css" />
  </head>
  
  <body>
    <div id="banner">
      <table border='0' cellpadding='0' cellspacing='0' width='100%'>
        <tr><td valign='top' align='left'>
          <div class="title">
            <span class="product">Net::SSH&mdash;</span><br />
            <span class="tagline">Secure Shell for Ruby</span>
          </div>
        </td><td valign='middle' align='right'>
          <div class="info">
            Net::SSH Version: <strong>1.1.4</strong><br />
            Manual Last Updated: <strong>2008-05-01 21:55 UTC</strong>
          </div>
        </td></tr>
      </table>
    </div>

    <table border='0' width='100%' cellpadding='0' cellspacing='0'>
      <tr><td valign='top'>

        <div id="navigation">
          <h1>Net::SSH Manual</h1>

          <h2>Chapters</h2>
          <ol type="I">
          
            <li>
                <a href="chapter-1.html">
                Introduction
                </a>
                
              <ol type="1">
                
                  <li><a href="chapter-1.html#s1">What is Net::SSH?</a></li>
                
                  <li><a href="chapter-1.html#s2">What isn&#8217;t Net::SSH?</a></li>
                
                  <li><a href="chapter-1.html#s3">Getting Net::SSH</a></li>
                
                  <li><a href="chapter-1.html#s4">License Information</a></li>
                
                  <li><a href="chapter-1.html#s5">Support</a></li>
                
                  <li><a href="chapter-1.html#s6">About the Author</a></li>
                
              </ol>
            </li>
          
            <li>
                <a href="chapter-2.html">
                Starting a Session
                </a>
                
              <ol type="1">
                
                  <li><a href="chapter-2.html#s1">Using Net::SSH.start</a></li>
                
                  <li><a href="chapter-2.html#s2">Using a Public/Private Key</a></li>
                
                  <li><a href="chapter-2.html#s3">Options</a></li>
                
                  <li><a href="chapter-2.html#s4">Using Net::SSH::Session</a></li>
                
              </ol>
            </li>
          
            <li>
                <a href="chapter-3.html">
                Channels
                </a>
                
              <ol type="1">
                
                  <li><a href="chapter-3.html#s1">What are Channels?</a></li>
                
                  <li><a href="chapter-3.html#s2">Session.loop</a></li>
                
                  <li><a href="chapter-3.html#s3">Channel Types</a></li>
                
                  <li><a href="chapter-3.html#s4">Opening a Channel</a></li>
                
                  <li><a href="chapter-3.html#s5">Callbacks</a></li>
                
                  <li><a href="chapter-3.html#s6">Channel Operations</a></li>
                
              </ol>
            </li>
          
            <li>
                <a href="chapter-4.html">
                Executing Commands
                </a>
                
              <ol type="1">
                
                  <li><a href="chapter-4.html#s1">Using Channels</a></li>
                
                  <li><a href="chapter-4.html#s2">Using #process.open</a></li>
                
                  <li><a href="chapter-4.html#s3">Using #process.popen3</a></li>
                
              </ol>
            </li>
          
            <li><strong>
                <a href="chapter-5.html">
                User Shells
                </a>
                </strong> <big>&larr;</big>
              <ol type="1">
                
                  <li><a href="chapter-5.html#s1">Introduction</a></li>
                
                  <li><a href="chapter-5.html#s2">Using Channels</a></li>
                
                  <li><a href="chapter-5.html#s3">Shell Service</a></li>
                
                  <li><a href="chapter-5.html#s4">SyncShell Service</a></li>
                
                  <li><a href="chapter-5.html#s5">Terminal Clients</a></li>
                
              </ol>
            </li>
          
            <li>
                <a href="chapter-6.html">
                Port Forwarding
                </a>
                
              <ol type="1">
                
                  <li><a href="chapter-6.html#s1">Introduction</a></li>
                
                  <li><a href="chapter-6.html#s2">Local-to-Remote</a></li>
                
                  <li><a href="chapter-6.html#s3">Remote-to-Local</a></li>
                
                  <li><a href="chapter-6.html#s4">Direct Channels</a></li>
                
                  <li><a href="chapter-6.html#s5">Remote-to-Local Handlers</a></li>
                
              </ol>
            </li>
          
            <li>
                <a href="chapter-7.html">
                Using Proxies
                </a>
                
              <ol type="1">
                
                  <li><a href="chapter-7.html#s1">Introduction</a></li>
                
                  <li><a href="chapter-7.html#s2"><span class="caps">HTTP</span></a></li>
                
                  <li><a href="chapter-7.html#s3"><span class="caps">SOCKS</span></a></li>
                
              </ol>
            </li>
          
          </ol>

          <h2>Other Documentation</h2>

          <ul>
            <li><a href="http://net-ssh.rubyforge.org/api/index.html">Net::SSH API</a></li>
            <li><a href="http://rubyforge.org/tracker/?atid=1842&group_id=274&func=browse">Net::SSH FAQ</a></li>
          </ul>

          <h2>Tutorials</h2>
          <ol>
          
          </ol>

          <p align="center"><strong>More To Come...</strong></p>

          <div class="license">
            <a href="http://creativecommons.org/licenses/by-sa/2.0/"><img alt="Creative Commons License" border="0" src="http://creativecommons.org/images/public/somerights" /></a><br />
            This manual is licensed under a <a href="http://creativecommons.org/licenses/by-sa/2.0/">Creative Commons License</a>.
          </div>
        </div>

      </td><td valign='top' width="100%">

        <div id="content">

           <div class="top"><div class="prevnext">
  
    <a href="chapter-4.html">Previous (4. Executing Commands)</a> |
  
  <a href="index.html">Up</a>
  
    | <a href="chapter-6.html">Next (6. Port Forwarding)</a>
  
</div></div>

<h1>5. User Shells</h1>



     <h2>
       <a name="s1"></a>
       5.1. Introduction
     </h2>

   

   <div class="section">
     <p>A user&#8217;s <em>shell</em> is the environment in which commands are executed on a remote machine. There are a variety of different shells, including <a href="http://www.gnu.org/software/bash/bash.html">bash</a>, csh, tcsh, <a href="http://www.kornshell.com/">ksh</a>, and many others.</p>


	<p>A shell may be executed like any other program, and when run, it (more-or-less) enters a read-execute-prompt cycle in which the user may interactively run commands.</p>


	<p><span class="caps">SSH</span> has special support for shells, allowing you to start a shell on a channel and have all subsequent data sent to that channel interpreted as the user&#8217;s input to the shell. Also, <span class="caps">SSH</span> supports pty&#8217;s (<em>pseudo-tty</em>&#8217;s, or terminals), which allow the shell to act as if it were running locally on the users own machine.</p>


	<p>Because a shell is just a program, you can always start a shell simply by executing it (as described in the previous chapter). However, you can also take advantage of <span class="caps">SSH</span>&#8217;s builtin shell support to execute the user&#8217;s preferred shell. This chapter will discuss this approach.</p>
   </div>



     <h2>
       <a name="s2"></a>
       5.2. Using Channels
     </h2>

   

   <div class="section">
     <p>At the lowest level, starting a shell is a matter of sending a &#8220;shell&#8221; request over a channel.</p>


	<div class='figure'>
<span class='caption'>Sending a shell request [ruby]</span>
<div class='body'><table border='0' cellpadding='0' cellspacing='0'><tr><td class='lineno'>1<br />2<br />3<br />4<br />5<br />6<br />7<br />8<br />9<br />10<br />11<br />12<br />13<br />14<br />15<br />16<br />17<br />18<br />19<br />20<br />21<br />22<br />23<br />24<br />25<br /></td><td width='100%'><link rel='stylesheet' type='text/css' href='stylesheets/ruby.css' /><div class='ruby'><pre><span class="constant">Net</span><span class="punct">::</span><span class="constant">SSH</span><span class="punct">.</span><span class="ident">start</span><span class="punct">(</span> <span class="ident">host</span> <span class="punct">)</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">session</span><span class="punct">|</span>

  <span class="ident">session</span><span class="punct">.</span><span class="ident">open_channel</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">channel</span><span class="punct">|</span>

    <span class="ident">channel</span><span class="punct">.</span><span class="ident">on_success</span> <span class="keyword">do</span>
      <span class="ident">puts</span> <span class="punct">&quot;</span><span class="string">shell was started successfully!</span><span class="punct">&quot;</span>
      <span class="ident">channel</span><span class="punct">.</span><span class="ident">send_data</span> <span class="punct">&quot;</span><span class="string">exit<span class="escape">\n</span></span><span class="punct">&quot;</span> <span class="comment"># tell the shell to exit</span>
    <span class="keyword">end</span>
    <span class="ident">channel</span><span class="punct">.</span><span class="ident">on_failure</span> <span class="keyword">do</span>
      <span class="ident">puts</span> <span class="punct">&quot;</span><span class="string">shell could not be started!</span><span class="punct">&quot;</span>
    <span class="keyword">end</span>
    <span class="ident">channel</span><span class="punct">.</span><span class="ident">on_data</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">ch</span><span class="punct">,</span><span class="ident">data</span><span class="punct">|</span>
      <span class="ident">puts</span> <span class="punct">&quot;</span><span class="string">recieved <span class="expr">#{data}</span> from shell</span><span class="punct">&quot;</span>
    <span class="keyword">end</span>
    <span class="ident">channel</span><span class="punct">.</span><span class="ident">on_close</span> <span class="keyword">do</span>
      <span class="ident">puts</span> <span class="punct">&quot;</span><span class="string">shell terminated</span><span class="punct">&quot;</span>
    <span class="keyword">end</span>

    <span class="ident">channel</span><span class="punct">.</span><span class="ident">send_request</span> <span class="punct">&quot;</span><span class="string">shell</span><span class="punct">&quot;,</span> <span class="constant">nil</span><span class="punct">,</span> <span class="constant">true</span>

  <span class="keyword">end</span>

  <span class="ident">session</span><span class="punct">.</span><span class="ident">loop</span>

<span class="keyword">end</span></pre></div></td></tr></table></div></div>


	<p>The <code>#send_request</code> method accepts three parameters&#8212;the name of the request (in this case, &#8220;shell&#8221;), any additional data to send with the request (none, in this case), and whether or not you want the server to reply with the success or failure of the request. In general, it is a good idea to ask for the server to reply, so that you know when you can start sending data to the shell.</p>


	<p>If you want to open a pty before starting the shell, you can use the #request_pty method of the channel:</p>


	<div class='figure'>
<span class='caption'>Opening a pty on a channel [ruby]</span>
<div class='body'><table border='0' cellpadding='0' cellspacing='0'><tr><td class='lineno'>1<br />2<br />3<br />4<br />5<br />6<br />7<br />8<br />9<br />10<br />11<br />12<br />13<br />14<br />15<br />16<br />17<br />18<br />19<br />20<br />21<br />22<br />23<br />24<br />25<br />26<br />27<br />28<br />29<br />30<br />31<br />32<br /></td><td width='100%'><link rel='stylesheet' type='text/css' href='stylesheets/ruby.css' /><div class='ruby'><pre><span class="constant">Net</span><span class="punct">::</span><span class="constant">SSH</span><span class="punct">.</span><span class="ident">start</span><span class="punct">(</span> <span class="ident">host</span> <span class="punct">)</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">session</span><span class="punct">|</span>

  <span class="ident">session</span><span class="punct">.</span><span class="ident">open_channel</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">channel</span><span class="punct">|</span>

    <span class="ident">channel</span><span class="punct">.</span><span class="ident">on_success</span> <span class="keyword">do</span>
      <span class="ident">puts</span> <span class="punct">&quot;</span><span class="string">pty was requested successfully!</span><span class="punct">&quot;</span>

      <span class="ident">channel</span><span class="punct">.</span><span class="ident">on_success</span> <span class="keyword">do</span>
        <span class="ident">puts</span> <span class="punct">&quot;</span><span class="string">shell was started successfully!</span><span class="punct">&quot;</span>
        <span class="ident">channel</span><span class="punct">.</span><span class="ident">send_data</span> <span class="punct">&quot;</span><span class="string">exit<span class="escape">\n</span></span><span class="punct">&quot;</span> <span class="comment"># tell the shell to exit</span>
      <span class="keyword">end</span>

      <span class="ident">channel</span><span class="punct">.</span><span class="ident">send_request</span> <span class="punct">&quot;</span><span class="string">shell</span><span class="punct">&quot;,</span> <span class="constant">nil</span><span class="punct">,</span> <span class="constant">true</span>
    <span class="keyword">end</span>

    <span class="ident">channel</span><span class="punct">.</span><span class="ident">on_failure</span> <span class="keyword">do</span>
      <span class="ident">puts</span> <span class="punct">&quot;</span><span class="string">shell could not be started!</span><span class="punct">&quot;</span>
    <span class="keyword">end</span>
    <span class="ident">channel</span><span class="punct">.</span><span class="ident">on_data</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">ch</span><span class="punct">,</span><span class="ident">data</span><span class="punct">|</span>
      <span class="ident">puts</span> <span class="punct">&quot;</span><span class="string">recieved <span class="expr">#{data}</span> from shell</span><span class="punct">&quot;</span>
    <span class="keyword">end</span>
    <span class="ident">channel</span><span class="punct">.</span><span class="ident">on_close</span> <span class="keyword">do</span>
      <span class="ident">puts</span> <span class="punct">&quot;</span><span class="string">shell terminated</span><span class="punct">&quot;</span>
    <span class="keyword">end</span>

    <span class="ident">channel</span><span class="punct">.</span><span class="ident">request_pty</span> <span class="symbol">:want_reply</span> <span class="punct">=&gt;</span> <span class="constant">true</span>

  <span class="keyword">end</span>

  <span class="ident">session</span><span class="punct">.</span><span class="ident">loop</span>

<span class="keyword">end</span></pre></div></td></tr></table></div></div>


	<p>First, the pty is requested (with an indicator to the server that it should return a &#8220;success&#8221; or &#8220;failure&#8221; notification). When the pty is successfully opened, the &#8220;on_success&#8221; callback is changed, and the shell is then requested.</p>


	<p>It&#8217;s a lot of hoops to jump through, but it gives you the finest-grained control over opening a shell. For most things, though, you can live with less control. For those tasks, there are the <em>shell</em> and <em>sync</em> services.</p>
   </div>



     <h2>
       <a name="s3"></a>
       5.3. Shell Service
     </h2>

   

   <div class="section">
     <p>To make interacting with shells, simpler, version 0.9 of Net::SSH introduced the <em>shell service</em>. This allows you to open a shell (with or without a pty), send a series of commands to the shell, and then wait for the output from the shell.</p>


	<div class='figure'>
<span class='caption'>Using the shell service [ruby]</span>
<div class='body'><table border='0' cellpadding='0' cellspacing='0'><tr><td class='lineno'>1<br />2<br />3<br />4<br />5<br />6<br />7<br />8<br />9<br />10<br />11<br />12<br />13<br />14<br />15<br />16<br />17<br />18<br />19<br />20<br />21<br />22<br />23<br />24<br />25<br />26<br /></td><td width='100%'><link rel='stylesheet' type='text/css' href='stylesheets/ruby.css' /><div class='ruby'><pre><span class="constant">Net</span><span class="punct">::</span><span class="constant">SSH</span><span class="punct">.</span><span class="ident">start</span><span class="punct">(</span> <span class="punct">'</span><span class="string">localhost</span><span class="punct">'</span> <span class="punct">)</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">session</span><span class="punct">|</span>

  <span class="ident">shell</span> <span class="punct">=</span> <span class="ident">session</span><span class="punct">.</span><span class="ident">shell</span><span class="punct">.</span><span class="ident">open</span>

  <span class="comment"># script what we want to do</span>
  <span class="ident">shell</span><span class="punct">.</span><span class="ident">pwd</span>
  <span class="ident">shell</span><span class="punct">.</span><span class="ident">cd</span> <span class="punct">&quot;</span><span class="string">/</span><span class="punct">&quot;</span>
  <span class="ident">shell</span><span class="punct">.</span><span class="ident">pwd</span>
  <span class="ident">shell</span><span class="punct">.</span><span class="ident">test</span> <span class="punct">&quot;</span><span class="string">-e foo</span><span class="punct">&quot;</span>
  <span class="ident">shell</span><span class="punct">.</span><span class="ident">cd</span> <span class="punct">&quot;</span><span class="string">/really/bogus/directory</span><span class="punct">&quot;</span>
  <span class="ident">shell</span><span class="punct">.</span><span class="ident">send_data</span> <span class="punct">&quot;</span><span class="string">/sbin/ifconfig<span class="escape">\n</span></span><span class="punct">&quot;</span>
  <span class="ident">shell</span><span class="punct">.</span><span class="ident">pwd</span>
  <span class="ident">shell</span><span class="punct">.</span><span class="ident">ruby</span> <span class="punct">&quot;</span><span class="string">-v</span><span class="punct">&quot;</span>
  <span class="ident">shell</span><span class="punct">.</span><span class="ident">cd</span> <span class="punct">&quot;</span><span class="string">/usr/lib</span><span class="punct">&quot;</span>
  <span class="ident">shell</span><span class="punct">.</span><span class="ident">pwd</span>
  <span class="ident">shell</span><span class="punct">.</span><span class="ident">exit</span>

  <span class="comment"># give the above commands sufficient time to terminate</span>
  <span class="ident">sleep</span> <span class="number">0.5</span>

  <span class="comment"># display the output</span>
  <span class="global">$stdout</span><span class="punct">.</span><span class="ident">print</span> <span class="ident">shell</span><span class="punct">.</span><span class="ident">stdout</span> <span class="keyword">while</span> <span class="ident">shell</span><span class="punct">.</span><span class="ident">stdout?</span>
  <span class="global">$stderr</span><span class="punct">.</span><span class="ident">puts</span> <span class="punct">&quot;</span><span class="string">-- stderr: --</span><span class="punct">&quot;</span>
  <span class="global">$stderr</span><span class="punct">.</span><span class="ident">print</span> <span class="ident">shell</span><span class="punct">.</span><span class="ident">stderr</span> <span class="keyword">while</span> <span class="ident">shell</span><span class="punct">.</span><span class="ident">stderr?</span>

<span class="keyword">end</span></pre></div></td></tr></table></div></div>


	<p>Any unrecognized method that is sent to the shell object is interpreted as a command to send to the server. To explicitly send a command, use the <code>#send_data</code> method (but remember to add a newline!). The <code>#send_data</code> method may also be used to send data to any process running in the shell as that process&#8217; <code>stdin</code> stream.</p>


	<p>You can also specify that a pty should be allocated for this shell:</p>


	<div class='figure'>
<span class='caption'>Allocating a pty for the shell [ruby]</span>
<div class='body'><table border='0' cellpadding='0' cellspacing='0'><tr><td class='lineno'>1<br />2<br />3<br />4<br />5<br />6<br />7<br />8<br />9<br /></td><td width='100%'><link rel='stylesheet' type='text/css' href='stylesheets/ruby.css' /><div class='ruby'><pre><span class="constant">Net</span><span class="punct">::</span><span class="constant">SSH</span><span class="punct">.</span><span class="ident">start</span><span class="punct">(</span> <span class="punct">'</span><span class="string">localhost</span><span class="punct">'</span> <span class="punct">)</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">session</span><span class="punct">|</span>

  <span class="ident">shell</span> <span class="punct">=</span> <span class="ident">session</span><span class="punct">.</span><span class="ident">shell</span><span class="punct">.</span><span class="ident">open</span><span class="punct">(</span> <span class="symbol">:pty</span> <span class="punct">=&gt;</span> <span class="constant">true</span> <span class="punct">)</span>

  <span class="comment"># or</span>

  <span class="ident">shell</span> <span class="punct">=</span> <span class="ident">session</span><span class="punct">.</span><span class="ident">shell</span><span class="punct">.</span><span class="ident">open</span><span class="punct">(</span> <span class="symbol">:pty</span> <span class="punct">=&gt;</span> <span class="punct">{</span> <span class="punct">...</span> <span class="punct">}</span> <span class="punct">)</span>

<span class="keyword">end</span></pre></div></td></tr></table></div></div>


	<p>If you give a hash for the <code>:pty</code> option, it must be a map of the options that describe the new pty. See the <span class="caps">API</span> documentation for the <code>Channel#request_pty</code> method for more information.</p>


	<p>Note that this is still an asynchronous approach. You send all the commands through the pipe and then wait for the output. (And be sure to give sufficient time or the processes to terminate!) This is fine for scripts that you just want to throw at the server, but many times you want a more interactive interface, for executing a command and receiving its output before moving on.</p>
   </div>



     <h2>
       <a name="s4"></a>
       5.4. SyncShell Service
     </h2>

   

   <div class="section">
     <p>The SyncShell service allows you to execute commands on the shell and block until they finish. It is not fool-proof&#8212;it has to use some tricks to accomplish this task, and some commands may foul it up. But for most tasks, it works admirably.</p>


	<div class='figure'>
<span class='caption'>Using the SyncShell service [ruby]</span>
<div class='body'><table border='0' cellpadding='0' cellspacing='0'><tr><td class='lineno'>1<br />2<br />3<br />4<br />5<br />6<br />7<br />8<br />9<br />10<br />11<br />12<br />13<br />14<br />15<br />16<br />17<br />18<br />19<br />20<br />21<br />22<br />23<br />24<br />25<br />26<br />27<br />28<br />29<br />30<br />31<br />32<br />33<br />34<br /></td><td width='100%'><link rel='stylesheet' type='text/css' href='stylesheets/ruby.css' /><div class='ruby'><pre><span class="constant">Net</span><span class="punct">::</span><span class="constant">SSH</span><span class="punct">.</span><span class="ident">start</span><span class="punct">(</span> <span class="punct">'</span><span class="string">localhost</span><span class="punct">'</span> <span class="punct">)</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">session</span><span class="punct">|</span>

  <span class="ident">shell</span> <span class="punct">=</span> <span class="ident">session</span><span class="punct">.</span><span class="ident">shell</span><span class="punct">.</span><span class="ident">sync</span>

  <span class="ident">out</span> <span class="punct">=</span> <span class="ident">shell</span><span class="punct">.</span><span class="ident">pwd</span>
  <span class="ident">p</span> <span class="ident">out</span><span class="punct">.</span><span class="ident">stdout</span>

  <span class="ident">out</span> <span class="punct">=</span> <span class="ident">shell</span><span class="punct">.</span><span class="ident">test</span> <span class="punct">&quot;</span><span class="string">-e foo</span><span class="punct">&quot;</span>
  <span class="ident">p</span> <span class="ident">out</span><span class="punct">.</span><span class="ident">status</span>

  <span class="ident">out</span> <span class="punct">=</span> <span class="ident">shell</span><span class="punct">.</span><span class="ident">cd</span> <span class="punct">&quot;</span><span class="string">/really/bogus/directory</span><span class="punct">&quot;</span>
  <span class="ident">p</span> <span class="ident">out</span><span class="punct">.</span><span class="ident">stderr</span>
  <span class="ident">p</span> <span class="ident">out</span><span class="punct">.</span><span class="ident">status</span>

  <span class="ident">out</span> <span class="punct">=</span> <span class="ident">shell</span><span class="punct">.</span><span class="ident">ruby</span> <span class="punct">&quot;</span><span class="string">-v</span><span class="punct">&quot;</span>
  <span class="ident">p</span> <span class="ident">out</span><span class="punct">.</span><span class="ident">stdout</span>

  <span class="ident">out</span> <span class="punct">=</span> <span class="ident">shell</span><span class="punct">.</span><span class="ident">cd</span> <span class="punct">&quot;</span><span class="string">/usr/lib</span><span class="punct">&quot;</span>

 <span class="ident">out</span> <span class="punct">=</span> <span class="ident">shell</span><span class="punct">.</span><span class="ident">ls</span> <span class="punct">&quot;</span><span class="string">-l</span><span class="punct">&quot;</span>
  <span class="ident">p</span> <span class="ident">out</span><span class="punct">.</span><span class="ident">stdout</span>

  <span class="ident">out</span> <span class="punct">=</span> <span class="ident">shell</span><span class="punct">.</span><span class="ident">send_command</span><span class="punct">(</span> <span class="punct">&quot;</span><span class="string">bc</span><span class="punct">&quot;,</span> <span class="punct">&lt;&lt;</span><span class="constant">CMD</span> <span class="punct">)</span><span class="string">
5+5
10*2
scale=5
3/4
quit
</span><span class="constant">CMD</span>
  <span class="ident">p</span> <span class="ident">out</span><span class="punct">.</span><span class="ident">stdout</span>

  <span class="ident">p</span> <span class="ident">shell</span><span class="punct">.</span><span class="ident">exit</span>

<span class="keyword">end</span></pre></div></td></tr></table></div></div>


	<p>The result of executing each command is an object that encapsulates the <code>stdout</code> and <code>stderr</code> streams, and the exit status of the command.</p>


	<p>To explicitly execute a command, use the <code>#send_command</code> instead of <code>#send_data</code>&#8212;otherwise, the command will be executed asynchronously, which is not what you want. Also, if you pass a second parameter to the <code>#send_command</code> method, it is interpreted as the <code>stdin</code> data to send to the new process.</p>
   </div>



     <h2>
       <a name="s5"></a>
       5.5. Terminal Clients
     </h2>

   

   <div class="section">
     <p>Using the shell service and pty&#8217;s, you can now create a simple <span class="caps">SSH</span> terminal client. (You&#8217;ll also want to download and install the <a href="http://arika.org/ruby/termios">ruby-termios</a> library so that your input is not interpreted in a linewise fashion.)</p>


	<div class='figure'>
<span class='caption'>A simple SSH terminal client in Ruby [ruby]</span>
<div class='body'><table border='0' cellpadding='0' cellspacing='0'><tr><td class='lineno'>1<br />2<br />3<br />4<br />5<br />6<br />7<br />8<br />9<br />10<br />11<br />12<br />13<br />14<br />15<br />16<br />17<br />18<br />19<br />20<br />21<br />22<br />23<br />24<br />25<br />26<br />27<br />28<br />29<br />30<br />31<br />32<br />33<br />34<br />35<br />36<br />37<br />38<br />39<br />40<br />41<br />42<br />43<br />44<br />45<br /></td><td width='100%'><link rel='stylesheet' type='text/css' href='stylesheets/ruby.css' /><div class='ruby'><pre><span class="keyword">begin</span>
  <span class="ident">require</span> <span class="punct">'</span><span class="string">termios</span><span class="punct">'</span>
<span class="keyword">rescue</span> <span class="constant">LoadError</span>
<span class="keyword">end</span>

<span class="keyword">def </span><span class="method">stdin_buffer</span><span class="punct">(</span> <span class="ident">enable</span> <span class="punct">)</span>
  <span class="keyword">return</span> <span class="keyword">unless</span> <span class="keyword">defined?</span><span class="punct">(</span> <span class="constant">Termios</span> <span class="punct">)</span>
  <span class="ident">attr</span> <span class="punct">=</span> <span class="constant">Termios</span><span class="punct">::</span><span class="ident">getattr</span><span class="punct">(</span> <span class="global">$stdin</span> <span class="punct">)</span>
  <span class="keyword">if</span> <span class="ident">enable</span>
    <span class="ident">attr</span><span class="punct">.</span><span class="ident">c_lflag</span> <span class="punct">|=</span> <span class="constant">Termios</span><span class="punct">::</span><span class="constant">ICANON</span> <span class="punct">|</span> <span class="constant">Termios</span><span class="punct">::</span><span class="constant">ECHO</span>
  <span class="keyword">else</span>
    <span class="ident">attr</span><span class="punct">.</span><span class="ident">c_lflag</span> <span class="punct">&amp;=</span> ~<span class="punct">(</span><span class="constant">Termios</span><span class="punct">::</span><span class="constant">ICANON</span><span class="punct">|</span><span class="constant">Termios</span><span class="punct">::</span><span class="constant">ECHO</span><span class="punct">)</span>
  <span class="keyword">end</span>
  <span class="constant">Termios</span><span class="punct">::</span><span class="ident">setattr</span><span class="punct">(</span> <span class="global">$stdin</span><span class="punct">,</span> <span class="constant">Termios</span><span class="punct">::</span><span class="constant">TCSANOW</span><span class="punct">,</span> <span class="ident">attr</span> <span class="punct">)</span>
<span class="keyword">end</span>

<span class="ident">host</span> <span class="punct">=</span> <span class="constant">ARGV</span><span class="punct">.</span><span class="ident">shift</span> <span class="keyword">or</span> <span class="ident">abort</span> <span class="punct">&quot;</span><span class="string">You must specify the [user@]host to connect to</span><span class="punct">&quot;</span>
<span class="keyword">if</span> <span class="ident">host</span> <span class="punct">=~</span> <span class="punct">/</span><span class="regex">@</span><span class="punct">/</span>
  <span class="ident">user</span><span class="punct">,</span> <span class="ident">host</span> <span class="punct">=</span> <span class="ident">host</span><span class="punct">.</span><span class="ident">match</span><span class="punct">(</span> <span class="punct">/</span><span class="regex">(.*?)@(.*)</span><span class="punct">/</span> <span class="punct">)[</span><span class="number">1</span><span class="punct">,</span><span class="number">2</span><span class="punct">]</span>
<span class="keyword">else</span>
  <span class="ident">user</span> <span class="punct">=</span> <span class="constant">ENV</span><span class="punct">['</span><span class="string">USER</span><span class="punct">']</span> <span class="punct">||</span> <span class="constant">ENV</span><span class="punct">['</span><span class="string">USER_NAME</span><span class="punct">']</span>
<span class="keyword">end</span>

<span class="constant">Net</span><span class="punct">::</span><span class="constant">SSH</span><span class="punct">.</span><span class="ident">start</span><span class="punct">(</span> <span class="ident">host</span><span class="punct">,</span> <span class="ident">user</span> <span class="punct">)</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">session</span><span class="punct">|</span>

 <span class="keyword">begin</span>
    <span class="ident">stdin_buffer</span> <span class="constant">false</span>

    <span class="ident">shell</span> <span class="punct">=</span> <span class="ident">session</span><span class="punct">.</span><span class="ident">shell</span><span class="punct">.</span><span class="ident">open</span><span class="punct">(</span> <span class="symbol">:pty</span> <span class="punct">=&gt;</span> <span class="constant">true</span> <span class="punct">)</span>

    <span class="ident">loop</span> <span class="keyword">do</span>
      <span class="keyword">break</span> <span class="keyword">unless</span> <span class="ident">shell</span><span class="punct">.</span><span class="ident">open?</span>
      <span class="keyword">if</span> <span class="constant">IO</span><span class="punct">.</span><span class="ident">select</span><span class="punct">([</span><span class="global">$stdin</span><span class="punct">],</span><span class="constant">nil</span><span class="punct">,</span><span class="constant">nil</span><span class="punct">,</span><span class="number">0.01</span><span class="punct">)</span>
        <span class="ident">data</span> <span class="punct">=</span> <span class="global">$stdin</span><span class="punct">.</span><span class="ident">sysread</span><span class="punct">(</span><span class="number">1</span><span class="punct">)</span>
        <span class="ident">shell</span><span class="punct">.</span><span class="ident">send_data</span> <span class="ident">data</span>
      <span class="keyword">end</span>

      <span class="global">$stdout</span><span class="punct">.</span><span class="ident">print</span> <span class="ident">shell</span><span class="punct">.</span><span class="ident">stdout</span> <span class="keyword">while</span> <span class="ident">shell</span><span class="punct">.</span><span class="ident">stdout?</span>
      <span class="global">$stdout</span><span class="punct">.</span><span class="ident">flush</span>
    <span class="keyword">end</span>
  <span class="keyword">ensure</span>
    <span class="ident">stdin_buffer</span> <span class="constant">true</span>
  <span class="keyword">end</span>

<span class="keyword">end</span></pre></div></td></tr></table></div></div>


	<p>The above code is also available as an example script in the Net::SSH distribution (<code>examples/ssh-client.rb</code>).</p>
   </div>



<div class="bottom"><div class="prevnext">
  
    <a href="chapter-4.html">Previous (4. Executing Commands)</a> |
  
  <a href="index.html">Up</a>
  
    | <a href="chapter-6.html">Next (6. Port Forwarding)</a>
  
</div></div>


        </div>

      </td></tr>
    </table>
  </body>
</html>
